<!-- Shared Chart Legend with Dropdown Toggles -->
<!-- Used by both /data extended view and /charts page -->

<div class="flex items-center gap-1 text-xs" x-data="chartLegend()" x-init="init()">
    <!-- Price ($) Group -->
    <div class="relative" @click.outside="openDropdown !== 'price' || (openDropdown = null)">
        <button @click.stop="toggleDropdown('price')"
                :class="isGroupActive('price') ? 'text-yellow-400 border-yellow-400/50' : 'text-gray-500 border-neutral-700'"
                class="px-2 py-1 rounded bg-neutral-800 border hover:bg-neutral-700 font-semibold transition-colors">
            $
        </button>
        <div x-show="openDropdown === 'price'" x-cloak
             x-ref="priceDropdown"
             x-transition:enter="transition ease-out duration-100"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-75"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             :style="getDropdownStyle('price')"
             class="fixed bg-neutral-800 border border-neutral-700 rounded shadow-lg z-[100] min-w-40 py-1">
            <button @click.stop="toggleAll('price')" class="w-full px-3 py-1.5 text-left hover:bg-neutral-700 flex items-center gap-2 border-b border-neutral-700">
                <span class="w-4 h-4 flex items-center justify-center border rounded"
                      :class="isAllActive('price') ? 'bg-yellow-500 border-yellow-500' : 'border-gray-500'">
                    <svg x-show="isAllActive('price')" class="w-3 h-3 text-black" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </span>
                <span class="text-yellow-400 font-medium">All</span>
            </button>
            <template x-for="item in legendItems.price" :key="item.key">
                <button @click.stop="toggleOverlay(item.key)" class="w-full px-3 py-1.5 text-left hover:bg-neutral-700 flex items-center gap-2">
                    <span class="w-4 h-4 flex items-center justify-center border rounded"
                          :class="visibilityState[item.key] ? 'border-yellow-500 bg-yellow-500' : 'border-gray-500'">
                        <svg x-show="visibilityState[item.key]" class="w-3 h-3 text-black" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </span>
                    <span class="w-3 h-0.5 rounded" :style="`background: ${item.color}`"></span>
                    <span class="text-gray-300" x-text="item.label"></span>
                </button>
            </template>
        </div>
    </div>

    <!-- Gamma (Γ) Group -->
    <div class="relative" @click.outside="openDropdown !== 'gamma' || (openDropdown = null)">
        <button @click.stop="toggleDropdown('gamma')"
                :class="isGroupActive('gamma') ? 'text-green-400 border-green-400/50' : 'text-gray-500 border-neutral-700'"
                class="px-2 py-1 rounded bg-neutral-800 border hover:bg-neutral-700 font-semibold transition-colors">
            Γ
        </button>
        <div x-show="openDropdown === 'gamma'" x-cloak
             x-ref="gammaDropdown"
             x-transition:enter="transition ease-out duration-100"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-75"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             :style="getDropdownStyle('gamma')"
             class="fixed bg-neutral-800 border border-neutral-700 rounded shadow-lg z-[100] min-w-40 py-1">
            <button @click.stop="toggleAll('gamma')" class="w-full px-3 py-1.5 text-left hover:bg-neutral-700 flex items-center gap-2 border-b border-neutral-700">
                <span class="w-4 h-4 flex items-center justify-center border rounded"
                      :class="isAllActive('gamma') ? 'bg-green-500 border-green-500' : 'border-gray-500'">
                    <svg x-show="isAllActive('gamma')" class="w-3 h-3 text-black" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </span>
                <span class="text-green-400 font-medium">All</span>
            </button>
            <template x-for="item in legendItems.gamma" :key="item.key">
                <button @click.stop="toggleOverlay(item.key)" class="w-full px-3 py-1.5 text-left hover:bg-neutral-700 flex items-center gap-2">
                    <span class="w-4 h-4 flex items-center justify-center border rounded"
                          :class="visibilityState[item.key] ? 'border-green-500 bg-green-500' : 'border-gray-500'">
                        <svg x-show="visibilityState[item.key]" class="w-3 h-3 text-black" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </span>
                    <span class="w-3 h-0.5 rounded" :style="`background: ${item.color}`"></span>
                    <span class="text-gray-300" x-text="item.label"></span>
                </button>
            </template>
        </div>
    </div>

    <!-- Delta (Δ) Group -->
    <div class="relative" @click.outside="openDropdown !== 'delta' || (openDropdown = null)">
        <button @click.stop="toggleDropdown('delta')"
                :class="isGroupActive('delta') ? 'text-orange-400 border-orange-400/50' : 'text-gray-500 border-neutral-700'"
                class="px-2 py-1 rounded bg-neutral-800 border hover:bg-neutral-700 font-semibold transition-colors">
            Δ
        </button>
        <div x-show="openDropdown === 'delta'" x-cloak
             x-ref="deltaDropdown"
             x-transition:enter="transition ease-out duration-100"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-75"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             :style="getDropdownStyle('delta')"
             class="fixed bg-neutral-800 border border-neutral-700 rounded shadow-lg z-[100] min-w-40 py-1">
            <button @click.stop="toggleAll('delta')" class="w-full px-3 py-1.5 text-left hover:bg-neutral-700 flex items-center gap-2 border-b border-neutral-700">
                <span class="w-4 h-4 flex items-center justify-center border rounded"
                      :class="isAllActive('delta') ? 'bg-orange-500 border-orange-500' : 'border-gray-500'">
                    <svg x-show="isAllActive('delta')" class="w-3 h-3 text-black" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </span>
                <span class="text-orange-400 font-medium">All</span>
            </button>
            <template x-for="item in legendItems.delta" :key="item.key">
                <button @click.stop="toggleOverlay(item.key)" class="w-full px-3 py-1.5 text-left hover:bg-neutral-700 flex items-center gap-2">
                    <span class="w-4 h-4 flex items-center justify-center border rounded"
                          :class="visibilityState[item.key] ? 'border-orange-500 bg-orange-500' : 'border-gray-500'">
                        <svg x-show="visibilityState[item.key]" class="w-3 h-3 text-black" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </span>
                    <span class="w-3 h-0.5 rounded" :style="`background: ${item.color}`"></span>
                    <span class="text-gray-300" x-text="item.label"></span>
                </button>
            </template>
        </div>
    </div>

    <!-- Time (Prior Sessions) Group -->
    <div class="relative" @click.outside="openDropdown !== 'prior' || (openDropdown = null)">
        <button @click.stop="toggleDropdown('prior')"
                :class="isGroupActive('prior') ? 'text-emerald-400 border-emerald-400/50' : 'text-gray-500 border-neutral-700'"
                class="px-2 py-1 rounded bg-neutral-800 border hover:bg-neutral-700 transition-colors"
                title="Prior session levels">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </button>
        <div x-show="openDropdown === 'prior'" x-cloak
             x-ref="priorDropdown"
             x-transition:enter="transition ease-out duration-100"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-75"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             :style="getDropdownStyle('prior')"
             class="fixed bg-neutral-800 border border-neutral-700 rounded shadow-lg z-[100] min-w-40 py-1">
            <button @click.stop="toggleAll('prior')" class="w-full px-3 py-1.5 text-left hover:bg-neutral-700 flex items-center gap-2 border-b border-neutral-700">
                <span class="w-4 h-4 flex items-center justify-center border rounded"
                      :class="isAllActive('prior') ? 'bg-emerald-500 border-emerald-500' : 'border-gray-500'">
                    <svg x-show="isAllActive('prior')" class="w-3 h-3 text-black" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </span>
                <span class="text-emerald-400 font-medium">All</span>
            </button>
            <template x-for="item in legendItems.prior" :key="item.key">
                <button @click.stop="toggleOverlay(item.key)" class="w-full px-3 py-1.5 text-left hover:bg-neutral-700 flex items-center gap-2">
                    <span class="w-4 h-4 flex items-center justify-center border rounded"
                          :class="visibilityState[item.key] ? 'border-emerald-500 bg-emerald-500' : 'border-gray-500'">
                        <svg x-show="visibilityState[item.key]" class="w-3 h-3 text-black" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </span>
                    <span class="w-3 h-0.5 rounded" :style="`background: ${item.color}`"></span>
                    <span class="text-gray-300" x-text="item.label"></span>
                </button>
            </template>
        </div>
    </div>

    <!-- Volume (V) Group -->
    <div class="relative" @click.outside="openDropdown !== 'volume' || (openDropdown = null)">
        <button @click.stop="toggleDropdown('volume')"
                :class="isGroupActive('volume') ? 'text-blue-400 border-blue-400/50' : 'text-gray-500 border-neutral-700'"
                class="px-2 py-1 rounded bg-neutral-800 border hover:bg-neutral-700 font-semibold transition-colors">
            V
        </button>
        <div x-show="openDropdown === 'volume'" x-cloak
             x-ref="volumeDropdown"
             x-transition:enter="transition ease-out duration-100"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-75"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             :style="getDropdownStyle('volume')"
             class="fixed bg-neutral-800 border border-neutral-700 rounded shadow-lg z-[100] min-w-40 py-1">
            <button @click.stop="toggleAll('volume')" class="w-full px-3 py-1.5 text-left hover:bg-neutral-700 flex items-center gap-2 border-b border-neutral-700">
                <span class="w-4 h-4 flex items-center justify-center border rounded"
                      :class="isAllActive('volume') ? 'bg-blue-500 border-blue-500' : 'border-gray-500'">
                    <svg x-show="isAllActive('volume')" class="w-3 h-3 text-black" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </span>
                <span class="text-blue-400 font-medium">All</span>
            </button>
            <template x-for="item in legendItems.volume" :key="item.key">
                <button @click.stop="toggleOverlay(item.key)" class="w-full px-3 py-1.5 text-left hover:bg-neutral-700 flex items-center gap-2">
                    <span class="w-4 h-4 flex items-center justify-center border rounded"
                          :class="visibilityState[item.key] ? 'border-blue-500 bg-blue-500' : 'border-gray-500'">
                        <svg x-show="visibilityState[item.key]" class="w-3 h-3 text-black" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </span>
                    <span class="w-3 h-0.5 rounded" :style="`background: ${item.color}`"></span>
                    <span class="text-gray-300" x-text="item.label"></span>
                </button>
            </template>
        </div>
    </div>
</div>

<script>
function chartLegend() {
    return {
        openDropdown: null,
        buttonRects: {},  // Store button positions for dropdown positioning

        // Local reactive visibility state (synced with TrainingChartView)
        // Default: only 0V, +VW, -VW visible
        visibilityState: {
            vwap: false,
            rollingVwap: false,
            vwapUpper1: false,
            vwapLower1: false,
            vwapUpper2: false,
            vwapLower2: false,
            zeroGex: false,
            zeroDex: false,
            positiveGws: false,
            negativeGws: false,
            deltaSupport: false,
            deltaResistance: false,
            gammaCallWall: false,
            gammaPutWall: false,
            dexCallWall: false,
            dexPutWall: false,
            mostActiveStrike: true,
            callWeightedStrike: true,
            putWeightedStrike: true,
            maxCallStrike: false,
            maxPutStrike: false,
            pointOfControl: false,
            premarketHigh: false,
            premarketLow: false,
            threeDayHigh: false,
            threeDayLow: false,
        },

        // Legend items with labels and colors for each group
        legendItems: {
            price: [
                { key: 'vwap', label: 'VWAP', color: '#eab308' },
                { key: 'rollingVwap', label: 'R-VWAP', color: '#06b6d4' },
                { key: 'vwapUpper1', label: '+1σ', color: '#a3e635' },
                { key: 'vwapLower1', label: '-1σ', color: '#a3e635' },
                { key: 'vwapUpper2', label: '+2σ', color: '#fb923c' },
                { key: 'vwapLower2', label: '-2σ', color: '#fb923c' },
                { key: 'pointOfControl', label: 'POC', color: '#a855f7' },
            ],
            gamma: [
                { key: 'zeroGex', label: '0GEX', color: '#9ca3af' },
                { key: 'positiveGws', label: '+ΓW', color: '#4ade80' },
                { key: 'negativeGws', label: '-ΓW', color: '#f87171' },
                { key: 'gammaCallWall', label: '+Γ', color: '#86efac' },
                { key: 'gammaPutWall', label: '-Γ', color: '#fca5a5' },
            ],
            delta: [
                { key: 'zeroDex', label: '0DEX', color: '#ffffff' },
                { key: 'deltaSupport', label: '+ΔW', color: '#a3e635' },
                { key: 'deltaResistance', label: '-ΔW', color: '#f472b6' },
                { key: 'dexCallWall', label: '+Δ', color: '#bef264' },
                { key: 'dexPutWall', label: '-Δ', color: '#f9a8d4' },
            ],
            prior: [
                { key: 'premarketHigh', label: 'PM High', color: '#34d399' },
                { key: 'premarketLow', label: 'PM Low', color: '#fb7185' },
                { key: 'threeDayHigh', label: '3D High', color: '#10b981' },
                { key: 'threeDayLow', label: '3D Low', color: '#f43f5e' },
            ],
            volume: [
                { key: 'mostActiveStrike', label: '0V', color: '#3b82f6' },
                { key: 'callWeightedStrike', label: '+VW', color: '#22c55e' },
                { key: 'putWeightedStrike', label: '-VW', color: '#ef4444' },
                { key: 'maxCallStrike', label: '+V', color: '#22c55e' },
                { key: 'maxPutStrike', label: '-V', color: '#ef4444' },
            ],
        },

        init() {
            // Sync initial state from TrainingChartView
            if (typeof TrainingChartView !== 'undefined' && TrainingChartView.overlayVisible) {
                Object.keys(this.visibilityState).forEach(key => {
                    if (TrainingChartView.overlayVisible.hasOwnProperty(key)) {
                        this.visibilityState[key] = TrainingChartView.overlayVisible[key];
                    }
                });
            }
        },

        toggleDropdown(group) {
            if (this.openDropdown === group) {
                this.openDropdown = null;
            } else {
                // Store button position before opening
                const btn = event.currentTarget;
                if (btn) {
                    this.buttonRects[group] = btn.getBoundingClientRect();
                }
                this.openDropdown = group;
            }
        },

        // Calculate dropdown position to respect viewport edges
        getDropdownStyle(group) {
            const rect = this.buttonRects[group];
            if (!rect) return '';

            const dropdownWidth = 160;  // min-w-40 = 10rem = 160px
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const margin = 8;

            // Calculate left position - prefer left-aligned, but shift left if would overflow right edge
            let left = rect.left;
            if (left + dropdownWidth > viewportWidth - margin) {
                // Align to right edge of button instead
                left = rect.right - dropdownWidth;
            }
            // Ensure doesn't go past left edge
            if (left < margin) {
                left = margin;
            }

            // Calculate top position - below button with small gap
            let top = rect.bottom + 4;

            // If dropdown would go below viewport, position above button instead
            const estimatedHeight = 200;  // Estimate dropdown height
            if (top + estimatedHeight > viewportHeight - margin) {
                top = rect.top - estimatedHeight - 4;
                if (top < margin) top = margin;
            }

            return `left: ${left}px; top: ${top}px;`;
        },

        isOverlayVisible(key) {
            return this.visibilityState[key] || false;
        },

        isGroupActive(group) {
            const items = this.legendItems[group] || [];
            return items.some(item => this.visibilityState[item.key]);
        },

        isAllActive(group) {
            const items = this.legendItems[group] || [];
            return items.every(item => this.visibilityState[item.key]);
        },

        toggleOverlay(key) {
            // Toggle local state (reactive)
            this.visibilityState[key] = !this.visibilityState[key];

            // Sync to TrainingChartView
            if (typeof TrainingChartView !== 'undefined') {
                TrainingChartView.overlayVisible[key] = this.visibilityState[key];
                const series = TrainingChartView.chartSeries[key];
                if (series) {
                    series.applyOptions({ visible: this.visibilityState[key] });
                }
            }
        },

        toggleAll(group) {
            const items = this.legendItems[group] || [];
            const allActive = this.isAllActive(group);
            const newState = !allActive;

            items.forEach(item => {
                // Update local state (reactive)
                this.visibilityState[item.key] = newState;

                // Sync to TrainingChartView
                if (typeof TrainingChartView !== 'undefined') {
                    TrainingChartView.overlayVisible[item.key] = newState;
                    const series = TrainingChartView.chartSeries[item.key];
                    if (series) {
                        series.applyOptions({ visible: newState });
                    }
                }
            });
        },
    };
}
</script>
