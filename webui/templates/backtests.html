{% extends "base.html" %}

{% block title %}Backtests - Spymaster{% endblock %}

{% block content %}
<div x-data="backtestsApp()" x-init="loadBacktests()">
    <div class="mb-6">
        <h1 class="text-2xl font-bold mb-2">Backtests</h1>
        <p class="text-gray-400">View and analyze backtest results</p>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="flex justify-center py-12">
        <svg class="animate-spin h-8 w-8 text-primary-500" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Empty State -->
    <div x-show="!loading && backtests.length === 0" class="bg-neutral-900 rounded-lg border border-neutral-800 p-8 text-center">
        <svg class="w-16 h-16 mx-auto mb-4 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        <h3 class="text-lg font-medium mb-2">No Backtests Found</h3>
        <p class="text-gray-400 mb-4">Run a backtest to see results here.</p>
        <p class="text-sm text-gray-500">Backtest JSON files should be saved to the <code class="bg-neutral-800 px-2 py-1 rounded">reports/</code> directory.</p>
    </div>

    <!-- Backtests Grid -->
    <div x-show="!loading && backtests.length > 0" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        <template x-for="bt in backtests" :key="bt.name">
            <a :href="'/backtest/' + bt.name.replace('.json', '')"
               class="bg-neutral-900 rounded-lg border border-neutral-800 p-4 hover:border-primary-500/50 transition-colors block">
                <div class="flex items-start justify-between mb-3">
                    <div>
                        <h3 class="font-medium text-white" x-text="bt.title || bt.name"></h3>
                        <p class="text-sm text-gray-500" x-text="bt.date_range ? bt.date_range.start + ' to ' + bt.date_range.end : ''"></p>
                        <template x-if="bt.strategy_id || bt.strategy_name">
                            <a :href="getStrategyLink(bt)"
                               class="text-xs text-primary-400 hover:text-primary-300"
                               @click.stop
                               x-text="'Strategy: ' + (bt.strategy_name || bt.strategy_id.substring(0, 8) + '...')"></a>
                        </template>
                    </div>
                    <span class="text-xs text-gray-500 bg-neutral-800 px-2 py-1 rounded" x-text="formatSize(bt.size)"></span>
                </div>

                <!-- Quick Metrics -->
                <div class="grid grid-cols-3 gap-2 text-sm">
                    <div class="bg-neutral-800/50 rounded px-2 py-1">
                        <div class="text-gray-500 text-xs">Return</div>
                        <div :class="bt.total_return >= 0 ? 'text-green-400' : 'text-red-400'"
                             x-text="bt.total_return != null ? (bt.total_return >= 0 ? '+' : '') + bt.total_return.toFixed(2) + '%' : '-'"></div>
                    </div>
                    <div class="bg-neutral-800/50 rounded px-2 py-1">
                        <div class="text-gray-500 text-xs">Trades</div>
                        <div class="text-white" x-text="bt.total_trades || '-'"></div>
                    </div>
                    <div class="bg-neutral-800/50 rounded px-2 py-1">
                        <div class="text-gray-500 text-xs">Win Rate</div>
                        <div :class="bt.win_rate >= 0.5 ? 'text-green-400' : 'text-yellow-400'"
                             x-text="bt.win_rate != null ? (bt.win_rate * 100).toFixed(1) + '%' : '-'"></div>
                    </div>
                </div>

                <div class="mt-3 text-xs text-gray-500">
                    Generated: <span x-text="bt.generated_at ? new Date(bt.generated_at).toLocaleString() : new Date(bt.modified).toLocaleString()"></span>
                </div>
            </a>
        </template>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function backtestsApp() {
    return {
        backtests: [],
        loading: true,

        async loadBacktests() {
            try {
                const response = await fetch('/api/backtests');
                this.backtests = await response.json();
            } catch (error) {
                console.error('Failed to load backtests:', error);
            } finally {
                this.loading = false;
            }
        },

        formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        },

        getStrategyLink(bt) {
            // Prefer strategy_name for URL (human-readable), fall back to strategy_id
            if (bt.strategy_name) {
                return '/strategies#' + bt.strategy_name;
            } else if (bt.strategy_id) {
                return '/strategies#id:' + bt.strategy_id;
            }
            return '#';
        }
    };
}
</script>
{% endblock %}
